<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Topics &mdash; PODIO  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=7f41d439"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Changing / creating new templates" href="templates.html" />
    <link rel="prev" title="Writing extra data outside an EDM" href="userdata.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            PODIO
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="doc.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="doc.html#quick-start">Quick-start</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">Design and Implementation Details</a><ul>
<li class="toctree-l2"><a class="reference internal" href="design.html#layout-of-objects">Layout of Objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="design.html#the-user-layer">The User Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html#the-internal-data-layer">The Internal Data Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html#the-pod-layer">The POD Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html#the-collections">The Collections</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html#vectorization-support-notebook-pattern">Vectorization support / notebook pattern</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="design.html#handling-mutability">Handling mutability</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="datamodel_syntax.html">Data Models and Data Model Definitions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="datamodel_syntax.html#basic-concepts-and-supported-features">Basic Concepts and Supported Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="datamodel_syntax.html#definition-of-custom-components">Definition of custom components</a></li>
<li class="toctree-l2"><a class="reference internal" href="datamodel_syntax.html#definition-of-custom-data-classes">Definition of custom data classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="datamodel_syntax.html#defining-members">Defining members</a></li>
<li class="toctree-l3"><a class="reference internal" href="datamodel_syntax.html#definition-of-references-between-objects">Definition of references between objects:</a></li>
<li class="toctree-l3"><a class="reference internal" href="datamodel_syntax.html#explicit-definition-of-methods">Explicit definition of methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="datamodel_syntax.html#global-options">Global options</a></li>
<li class="toctree-l2"><a class="reference internal" href="datamodel_syntax.html#extending-a-datamodel-using-types-from-an-upstream-datamodel">Extending a datamodel / using types from an upstream datamodel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="datamodel_syntax.html#potential-pitfalls">Potential pitfalls</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples for Supported Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="examples.html#object-ownership">Object Ownership</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#object-creation-and-storage">Object Creation and Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#object-references">Object References</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#looping-through-collections">Looping through Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#support-for-notebook-pattern">Support for Notebook-Pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#podio-frame-container"><code class="docutils literal notranslate"><span class="pre">podio::Frame</span></code> container</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#object-retrieval">Object Retrieval</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#user-defined-meta-data">User defined Meta Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="examples.html#python-interface">Python Interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="frame.html">The <code class="docutils literal notranslate"><span class="pre">Frame</span></code> concept</a><ul>
<li class="toctree-l2"><a class="reference internal" href="frame.html#basic-functionality-of-a-frame">Basic functionality of a <code class="docutils literal notranslate"><span class="pre">Frame</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="frame.html#usage-examples-for-collection-data">Usage examples for collection data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="frame.html#putting-collection-data-into-the-frame">Putting collection data into the <code class="docutils literal notranslate"><span class="pre">Frame</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="frame.html#getting-collection-references-from-the-frame">Getting collection (references) from the <code class="docutils literal notranslate"><span class="pre">Frame</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="frame.html#usage-for-parameters">Usage for Parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="frame.html#i-o-basics-and-philosophy">I/O basics and philosophy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="frame.html#writing-a-frame">Writing a <code class="docutils literal notranslate"><span class="pre">Frame</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="frame.html#reading-a-frame">Reading a <code class="docutils literal notranslate"><span class="pre">Frame</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="frame.html#schema-evolution">Schema evolution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="frame.html#frame-implementation-and-design">Frame implementation and design</a></li>
<li class="toctree-l1"><a class="reference internal" href="userdata.html">Writing extra data outside an EDM</a><ul>
<li class="toctree-l2"><a class="reference internal" href="userdata.html#example-usage">Example usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="userdata.html#some-limitations">Some limitations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="userdata.html#no-relations-to-other-collections">No relations to other collections</a></li>
<li class="toctree-l3"><a class="reference internal" href="userdata.html#limited-supported-types">Limited supported types</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#writing-extra-data-outside-the-edm">Writing extra data outside the EDM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changing-creating-new-templates">Changing / creating new templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#persistency">Persistency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#writing-back-end">Writing Back-End</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reading-back-end">Reading Back-End</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dumping-json">Dumping JSON</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#thread-safety">Thread-safety</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#changing-user-data">Changing user data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#serialization">Serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#not-thread-safe-components">Not-thread-safe components</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#running-pre-commit">Running pre-commit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#retrieving-the-edm-definition-from-a-data-file">Retrieving the EDM definition from a data file</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#accessing-the-edm-definition-programmatically">Accessing the EDM definition programmatically</a></li>
<li class="toctree-l3"><a class="reference internal" href="#technical-details-on-edm-definition-embedding">Technical details on EDM definition embedding</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-datamodelregistry">The <code class="docutils literal notranslate"><span class="pre">DatamodelRegistry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#i-o-helpers-for-edm-definition-storing">I/O helpers for EDM definition storing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">Changing / creating new templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="templates.html#preprocessing-of-yaml-file">Preprocessing of yaml file</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#existing-templates">Existing templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#adding-a-new-template">Adding a new template</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#available-information-in-the-templates">Available information in the templates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="templates.html#general-information">General information</a></li>
<li class="toctree-l3"><a class="reference internal" href="templates.html#components">Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="templates.html#datatypes">Datatypes</a></li>
<li class="toctree-l3"><a class="reference internal" href="templates.html#membervariable"><code class="docutils literal notranslate"><span class="pre">MemberVariable</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="templates.html#datatype"><code class="docutils literal notranslate"><span class="pre">DataType</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="templates.html#julia-code-generation">Julia code generation</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PODIO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Advanced Topics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-topics">
<h1>Advanced Topics<a class="headerlink" href="#advanced-topics" title="Link to this heading"></a></h1>
<section id="writing-extra-data-outside-the-edm">
<h2>Writing extra data outside the EDM<a class="headerlink" href="#writing-extra-data-outside-the-edm" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="userdata.html"><span class="std std-doc">See here</span></a></p>
</section>
<section id="changing-creating-new-templates">
<h2>Changing / creating new templates<a class="headerlink" href="#changing-creating-new-templates" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="templates.html"><span class="std std-doc">See here</span></a></p>
</section>
<section id="persistency">
<h2>Persistency<a class="headerlink" href="#persistency" title="Link to this heading"></a></h2>
<p>The library is build such that it can support multiple storage backends. However, the tested storage system being used is ROOT.
The following explains the requirements for a user-provided storage back-end.</p>
<section id="writing-back-end">
<h3>Writing Back-End<a class="headerlink" href="#writing-back-end" title="Link to this heading"></a></h3>
<p>There is no interface a writing class has to fulfill. It only needs to take advantage of the interfaces provided in PODIO. To persistify a collection, three pieces of information have to be stored:</p>
<ol class="arabic simple">
<li><p>the ID of the collection,</p></li>
<li><p>the vector of PODs in the collection, and</p></li>
<li><p>the relation information in the collection</p></li>
</ol>
<p>Before writing out a collection, the data need to be put into the proper structure. For this, the method <code class="docutils literal notranslate"><span class="pre">prepareForWrite</span></code> needs to be invoked. In the case of trivial POD members this results in a no-op. In case, the collection contains references to other collections, the pointers are being translated into <code class="docutils literal notranslate"><span class="pre">collID:objIndex</span></code> pairs. A serialization solution would - in principle - then look like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="n">collection</span><span class="o">-&gt;</span><span class="n">prepareForWrite</span><span class="p">();</span>
<span class="w">     </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collection</span><span class="o">-&gt;</span><span class="n">getBufferAddress</span><span class="p">();</span>
<span class="w">     </span><span class="k">auto</span><span class="w"> </span><span class="n">refCollections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collection</span><span class="o">-&gt;</span><span class="n">referenceCollections</span><span class="p">();</span>
<span class="w">     </span><span class="c1">// ...</span>
<span class="w">     </span><span class="c1">//   write buffer, collection ID, and refCollections</span>
<span class="w">     </span><span class="c1">// ...</span>
</pre></div>
</div>
</section>
<section id="reading-back-end">
<h3>Reading Back-End<a class="headerlink" href="#reading-back-end" title="Link to this heading"></a></h3>
<p>The main requirement for a reading backend is its capability of reading back all
the necessary data from which a collection can be constructed in the form of
<code class="docutils literal notranslate"><span class="pre">podio::CollectionReadBuffers</span></code>. From these buffers collections can then be
constructed. Each instance has to contain the (type erased) POD buffers (as a
<code class="docutils literal notranslate"><span class="pre">std::vector</span></code>), the (possibly empty) vectors of <code class="docutils literal notranslate"><span class="pre">podio::ObjectID</span></code>s that contain
the relation information as well the (possibly empty) vectors for the vector
member buffers, which are currently stored as pairs of the type (as a
<code class="docutils literal notranslate"><span class="pre">std::string</span></code>) and (type erased) data buffers in the form of <code class="docutils literal notranslate"><span class="pre">std::vector</span></code>s.</p>
</section>
<section id="dumping-json">
<h3>Dumping JSON<a class="headerlink" href="#dumping-json" title="Link to this heading"></a></h3>
<p>It is possible to turn on an automatic conversion to JSON for podio generated datamodels using the <a class="reference external" href="https://github.com/nlohmann/json">nlohmann/json</a> library.
To enable this feature the <strong>core datamodel library</strong> has to be compiled with the <code class="docutils literal notranslate"><span class="pre">PODIO_JSON_OUTPUT</span></code> and linked against the nlohmann/json library (needs at least version 3.10).
In cmake the necessary steps are (assuming that <code class="docutils literal notranslate"><span class="pre">datamodel</span></code> is the datamodel core library)</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">find_library</span><span class="p">(</span><span class="s">nlohmann_json</span><span class="w"> </span><span class="s">3.10</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="nb">target_link_library</span><span class="p">(</span><span class="s">datamodel</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s">nlohmann_json::nlohmann_json</span><span class="p">)</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span><span class="s">datamodel</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s">PODIO_JSON_OUTPUT</span><span class="p">)</span>
</pre></div>
</div>
<p>With JSON support enabled it is possible to convert collections (or single objects) to JSON simply via</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;nlohmann/json.hpp&quot;</span>

<span class="k">auto</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">// get collection from somewhere</span>

<span class="n">nlohmann</span><span class="o">::</span><span class="n">json</span><span class="w"> </span><span class="n">json</span><span class="p">{</span>
<span class="w">   </span><span class="p">{</span><span class="s">&quot;collectionName&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">collection</span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Each element of the collection will be converted to a JSON object, where the keys are the same as in the datamodel definiton.
Components contained in the objects will similarly be similarly converted.</p>
<p><strong>JSON is not foreseen as a mode for persistency, i.e. there is no plan to add the conversion from JSON to the in memory representation of the datamodel.</strong></p>
</section>
</section>
<section id="thread-safety">
<h2>Thread-safety<a class="headerlink" href="#thread-safety" title="Link to this heading"></a></h2>
<p>PODIO was written with thread-safety in mind and avoids the usage of globals and statics.
However, a few assumptions about user code and use-patterns were made.
The following lists the caveats of the library when it comes to parallelization.</p>
<section id="changing-user-data">
<h3>Changing user data<a class="headerlink" href="#changing-user-data" title="Link to this heading"></a></h3>
<p>As explained in the section about mutability of data, thread-safety is only guaranteed if data are considered read-only after creation.</p>
</section>
<section id="serialization">
<h3>Serialization<a class="headerlink" href="#serialization" title="Link to this heading"></a></h3>
<p>During the calls of <code class="docutils literal notranslate"><span class="pre">prepareForWriting</span></code> and <code class="docutils literal notranslate"><span class="pre">prepareAfterReading</span></code> on collections other operations like object creation or addition will lead to an inconsistent state.</p>
</section>
<section id="not-thread-safe-components">
<h3>Not-thread-safe components<a class="headerlink" href="#not-thread-safe-components" title="Link to this heading"></a></h3>
<p>The Readers and Writers that ship with podio are assumed to run on a single
thread only (more precisely we assume that each Reader or Writer doesn’t have to
synchronize with any other for file operations).</p>
</section>
</section>
<section id="running-pre-commit">
<h2>Running pre-commit<a class="headerlink" href="#running-pre-commit" title="Link to this heading"></a></h2>
<ul>
<li><p>Install <a class="reference external" href="https://pre-commit.com/">pre-commit</a></p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">pre-commit</span></code></p>
</li>
<li><p>Run pre-commit manually</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">pre-commit</span> <span class="pre">run</span> <span class="pre">--all-files</span></code></p>
</li>
</ul>
</section>
<section id="retrieving-the-edm-definition-from-a-data-file">
<h2>Retrieving the EDM definition from a data file<a class="headerlink" href="#retrieving-the-edm-definition-from-a-data-file" title="Link to this heading"></a></h2>
<p>It is possible to get the EDM definition(s) that was used to generate the
datatypes that are stored in a data file. This makes it possible to re-generate
the necessary code and build all libraries again in case they are not easily
available otherwise. To see which EDM definitions are available in a data file
use the <code class="docutils literal notranslate"><span class="pre">podio-dump</span></code> utility</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>podio-dump<span class="w"> </span>&lt;data-file&gt;
</pre></div>
</div>
<p>which will give an (exemplary) output like this</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">input</span><span class="w"> </span><span class="n">file</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">file</span><span class="o">&gt;</span>

<span class="n">EDM</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">definitions</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">file</span><span class="o">:</span><span class="w"> </span><span class="n">edm4hep</span>

<span class="p">[...]</span>
</pre></div>
</div>
<p>To actually dump the model definition to stdout use the <code class="docutils literal notranslate"><span class="pre">--dump-edm</span></code> option
and the name of the datamodel you want to dump:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>podio-dump<span class="w"> </span>--dump-edm<span class="w"> </span>edm4hep<span class="w"> </span>&lt;data-file&gt;<span class="w"> </span>&gt;<span class="w"> </span>dumped_edm4hep.yaml
</pre></div>
</div>
<p>Here we directly redirected the output to a yaml file that can then again be
used by the <code class="docutils literal notranslate"><span class="pre">podio_class_generator.py</span></code> to generate the corresponding c++ code
(or be passed to the cmake macros).</p>
<p><strong>Note that the dumped EDM definition is equivalent but not necessarily exactly
the same as the original EDM definition.</strong> E.g. all the datatypes will have all
their fields (<code class="docutils literal notranslate"><span class="pre">Members</span></code>, <code class="docutils literal notranslate"><span class="pre">OneToOneRelations</span></code>, <code class="docutils literal notranslate"><span class="pre">OneToManyRelations</span></code>,
<code class="docutils literal notranslate"><span class="pre">VectorMembers</span></code>) defined, and defaulted to empty lists in case they were not
present in the original EDM definition. The reason for this is that the embedded
EDM definition is the pre-processed and validated one <a class="reference internal" href="#technical-details-on-edm-definition-embedding"><span class="xref myst">as described
below</span></a></p>
<section id="accessing-the-edm-definition-programmatically">
<h3>Accessing the EDM definition programmatically<a class="headerlink" href="#accessing-the-edm-definition-programmatically" title="Link to this heading"></a></h3>
<p>The EDM definition can also be accessed programmatically via the
<code class="docutils literal notranslate"><span class="pre">[ROOT|SIO]FrameReader::getEDMDefinition</span></code> method. It takes an EDM name as its
single argument and returns the EDM definition as a JSON string. Most likely
this has to be decoded into an actual JSON structure in order to be usable (e.g.
via <code class="docutils literal notranslate"><span class="pre">json.loads</span></code> in python to get a <code class="docutils literal notranslate"><span class="pre">dict</span></code>).</p>
</section>
<section id="technical-details-on-edm-definition-embedding">
<h3>Technical details on EDM definition embedding<a class="headerlink" href="#technical-details-on-edm-definition-embedding" title="Link to this heading"></a></h3>
<p>The EDM definition is embedded into the core EDM library as a raw string literal
in JSON format. This string is generated into the <code class="docutils literal notranslate"><span class="pre">DatamodelDefinition.h</span></code> file as</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="o">&lt;</span><span class="nn">package_name</span><span class="o">&gt;::</span><span class="nn">meta</span><span class="w"> </span><span class="p">{</span>
<span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&lt;</span><span class="n">package_name</span><span class="o">&gt;</span><span class="n">__JSONDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">EDMDEFINITION(</span><span class="s">&lt;json encoded definition&gt;</span><span class="dl">)EDMDEFINITION</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;package_name&gt;</span></code> is the name of the EDM as passed to the
<code class="docutils literal notranslate"><span class="pre">podio_class_generator.py</span></code> (or the cmake macro). The <code class="docutils literal notranslate"><span class="pre">&lt;json</span> <span class="pre">encoded</span> <span class="pre">definition&gt;</span></code>
is obtained from the pre-processed EDM definition that is read from the yaml
file. During this pre-processing the EDM definition is validated, and optional
fields are filled with empty defaults. Additionally, the <code class="docutils literal notranslate"><span class="pre">includeSubfolder</span></code>
option will be populated with the actual include subfolder, in case it has been
set to <code class="docutils literal notranslate"><span class="pre">True</span></code> in the yaml file. Since the json encoded definition is generated
right before the pre-processed model is passed to the class generator, this
definition is equivalent, but not necessarily equal to the original definition.</p>
<section id="the-datamodelregistry">
<h4>The <code class="docutils literal notranslate"><span class="pre">DatamodelRegistry</span></code><a class="headerlink" href="#the-datamodelregistry" title="Link to this heading"></a></h4>
<p>To make access to information about currently loaded and available datamodels a
bit easier the <code class="docutils literal notranslate"><span class="pre">DatamodelRegistry</span></code> (singleton) keeps a map of all loaded
datamodels and provides access to this information possible. In this context we
refer to an <em>EDM</em> as the shared library (and the corresponding public headers)
that have been compiled from code that has been generated from a <em>datamodel
definition</em> in the original YAML file. In general whenever we refer to a
<em>datamodel</em> in this context we mean the enitity as a whole, i.e. its definition
in a YAML file, the concrete implementation as an EDM, as well as other related
information that is related to it.</p>
<p>Currently the <code class="docutils literal notranslate"><span class="pre">DatamodelRegistry</span></code> provides mainly access to the original
definition of available datamodels via two methods:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="nf">getDatamodelDefinition</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">edmName</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="nf">getDatamodelDefinition</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">index</span></code> can be obtained from each collection via
<code class="docutils literal notranslate"><span class="pre">getDatamodelRegistryIndex</span></code>. That in turn simply calls
<code class="docutils literal notranslate"><span class="pre">&lt;package_name&gt;::meta::DatamodelRegistryIndex::value()</span></code>, another singleton like object
that takes care of registering an EDM definition to the <code class="docutils literal notranslate"><span class="pre">DatamodelRegistry</span></code>
during its static initialization. It is also defined in the
<code class="docutils literal notranslate"><span class="pre">DatamodelDefinition.h</span></code> header.</p>
<p>Since the datamodel definition is embedded as a raw string literal into the core
EDM shared library, it is in principle also relatively straight forward to
retrieve it from this library by inspecting the binary, e.g. via</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>readelf<span class="w"> </span>-p<span class="w"> </span>.rodata<span class="w"> </span>libedm4hep.so<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>options
</pre></div>
</div>
<p>which will result in something like</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">300</span><span class="p">]</span><span class="w">  </span><span class="p">{</span><span class="s">&quot;options&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;getSyntax&quot;</span><span class="o">:</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;exposePODMembers&quot;</span><span class="o">:</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;includeSubfolder&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;edm4hep/&quot;</span><span class="p">},</span><span class="w"> </span><span class="s">&quot;components&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span><span class="p">},</span><span class="w"> </span><span class="s">&quot;datatypes&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="i-o-helpers-for-edm-definition-storing">
<h4>I/O helpers for EDM definition storing<a class="headerlink" href="#i-o-helpers-for-edm-definition-storing" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">podio/utilities/DatamodelRegistryIOHelpers.h</span></code> header defines two utility
classes, that help with instrumenting readers and writers with functionality to
read and write all the necessary EDM definitions.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">DatamodelDefinitionCollector</span></code> is intended for usage in writers. It
essentially collects the datamodel definitions of all the collections it encounters.
The <code class="docutils literal notranslate"><span class="pre">registerDatamodelDefinition</span></code> method it provides should be called with every collection
that is written. The <code class="docutils literal notranslate"><span class="pre">getDatamodelDefinitionsToWrite</span></code> method returns a vector of all
datamodel names and their definition that were encountered during writing. <strong>It is
then the writers responsibility to actually store this information into the
file</strong>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">DatamodelDefinitionHolder</span></code> is intended to be used by readers. It
provides the <code class="docutils literal notranslate"><span class="pre">getDatamodelDefinition</span></code> and <code class="docutils literal notranslate"><span class="pre">getAvailableDatamodels</span></code> methods.
<strong>It is again the readers property to correctly populate it with the data it
has read from file.</strong> Currently the <code class="docutils literal notranslate"><span class="pre">SIOFrameReader</span></code> and the <code class="docutils literal notranslate"><span class="pre">ROOTFrameReader</span></code>
use it and also offer the same functionality as public methods with the help
of it.</p></li>
</ul>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Key4hep authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: v00-99
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions"><dl>
      <dt>Versions</dt>
      <dd><a href="../docs-on-gh-pages/advanced_topics.html">docs-on-gh-pages</a></dd>
      <dd><a href="../master/advanced_topics.html">master</a></dd>
      <dd><a href="../v00-00-00/advanced_topics.html">v00-00-00</a></dd>
      <dd><a href="advanced_topics.html">v00-99</a></dd>
      <dd><a href="../v99-99-99/advanced_topics.html">v99-99-99</a></dd>
    </dl></div>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>